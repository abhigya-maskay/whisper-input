# Current Task: Step 5 â€“ Develop Audio Recorder

- [x] Diagram recorder lifecycle covering stream initialization, buffer management, and shutdown responsibilities
- [x] Specify configuration fields required from `InputConfig`/audio section, including defaults and validation ranges
- [x] Choose buffering mechanism (e.g., `queue.Queue` or `collections.deque`) and define PCM chunk format (dtype, endian, channels)
- [x] Research `sounddevice.InputStream` callback signature and map to buffering strategy with thread-safe data transfer to async context
- [x] Define error handling strategy for stream exceptions (callback errors, device busy) and logging expectations
- [x] Outline optional silence trimming approach: energy threshold selection, minimum silence duration, and fallback when disabled
- [x] Sketch temporary storage handling (use `tempfile.NamedTemporaryFile`, ensure cleanup on failure) and WAV encoding parameters
- [x] Implement `start()` to instantiate `InputStream`, register callback, prime buffers, and transition internal state guards
- [x] Implement `stop()` to stop/close stream, collect buffered frames, apply trimming routine, and write WAV via `wave.open`
- [x] Add helper to convert buffered frames into numpy array or bytes, respecting sample width and channel layout
- [x] Ensure `stop()` raises `RuntimeError` when called before `start()` or if no audio captured, with descriptive messages
- [x] Implement context manager or explicit `close()` to guarantee stream cleanup when orchestrator aborts mid-recording
- [x] Implement `list_devices()` calling `sounddevice.query_devices()`, filtering `max_input_channels > 0`, and returning ordered mapping
- [x] Handle `sounddevice.PortAudioError` in `list_devices()` with logged warning and empty result to mirror button discovery behavior
- [x] Write unit test for `start()`/`stop()` lifecycle using mocks to ensure stream methods invoked in order
- [x] Write unit test verifying silence trimming logic against synthetic PCM buffers (trim lead/trail silence but keep core audio)
- [x] Write unit test ensuring temporary WAV file creation, correct sample rate metadata, and cleanup on exceptions
- [x] Write unit test for `list_devices()` filtering and error handling using patched `sounddevice.query_devices`
- [x] Write unit test for error paths (`stop()` without `start()`, stream raising exception) ensuring `RuntimeError` surfaces
